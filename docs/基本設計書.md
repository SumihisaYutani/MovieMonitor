# MovieMonitor 基本設計書

## 1. システム概要

### 1.1 システム構成
```
┌─────────────────────────┐
│      WPF Application    │  ← Windowsネイティブアプリ
│  ┌─────────────────────┐ │
│  │     Main Window     │ │  ← メインウィンドウ
│  │   - 動画一覧表示   │ │
│  │   - 検索・フィルタ │ │
│  └─────────────────────┘ │
│  ┌─────────────────────┐ │
│  │  Settings Window    │ │  ← 設定ウィンドウ
│  │   - 設定管理       │ │
│  └─────────────────────┘ │
└─────────────────────────┘
           │
           │ サービス層
           │
┌─────────────────────────┐
│       Services          │
│  - DatabaseService      │  ← LiteDB操作
│  - VideoScanService     │  ← ファイルスキャン
│  - ThumbnailService     │  ← サムネイル生成
│  - ConfigurationService │  ← 設定管理
└─────────────────────────┘
```

### 1.2 技術スタック
- **フレームワーク**: WPF + .NET 8
- **データベース**: LiteDB (軽量NoSQL) + 複合インデックス最適化
- **動画処理**: FFMpegCore (PNG サムネイル生成)
- **ログ**: Serilog (ファイル・行番号付きログ)
- **MVVM**: CommunityToolkit.Mvvm + カスタムRelayCommand
- **UI**: Material Design風カスタムスタイル + レスポンシブレイアウト (100-600px可変)
- **DI**: Microsoft.Extensions.DependencyInjection
- **値変換**: カスタムコンバーター (サムネイルサイズ連動)
- **デプロイ**: Single File Executable (164MB、全依存関係内包)

## 2. アーキテクチャ設計

### 2.1 ディレクトリ構造
```
MovieMonitor/
├── src/                          # ソースコード
│   ├── MovieMonitor.csproj       # プロジェクトファイル
│   ├── Program.cs                # エントリーポイント (WPF自動生成)
│   ├── App.xaml                  # アプリケーション設定
│   ├── MainWindow.xaml           # メインウィンドウ
│   ├── Models/                   # データモデル
│   │   ├── VideoFile.cs          # 動画ファイル情報
│   │   ├── SearchFilter.cs       # 検索フィルター
│   │   ├── ScanProgress.cs       # スキャン進行状況
│   │   └── AppSettings.cs        # アプリケーション設定
│   ├── Services/                 # サービス層
│   │   ├── IConfigurationService.cs  # 設定サービス
│   │   ├── ConfigurationService.cs
│   │   ├── IDatabaseService.cs       # データベースサービス
│   │   ├── DatabaseService.cs
│   │   ├── IVideoScanService.cs      # 動画スキャンサービス
│   │   ├── VideoScanService.cs
│   │   ├── IThumbnailService.cs      # サムネイルサービス
│   │   └── ThumbnailService.cs
│   ├── ViewModels/               # MVVM ViewModels
│   │   ├── MainViewModel.cs      # メインViewModel
│   │   └── SettingsViewModel.cs  # 設定ViewModel
│   ├── Views/                    # ビュー
│   │   └── SettingsWindow.xaml   # 設定ウィンドウ
│   ├── Converters/               # 値コンバーター
│   │   ├── BooleanToVisibilityConverter.cs
│   │   └── ThumbnailSizeConverters.cs  # サムネイルサイズ変換
│   ├── Extensions/               # 拡張メソッド
│   │   └── SerilogExtensions.cs  # ログ拡張
│   └── Resources/                # リソースファイル
│       ├── Styles.xaml           # UIスタイル (Material Design)
│       └── Icons/                # アプリケーションアイコン
│           ├── app-icon.ico      # 実行ファイル用アイコン
│           └── app-icon.svg      # SVGソースファイル
├── docs/                         # ドキュメント
│   ├── 要件定義書.md
│   ├── 基本設計書.md
│   ├── 詳細設計書.md
│   ├── ER図.md
│   ├── クラス図.md
│   └── データ仕様書.md
└── claude.md                     # 開発ガイドライン
```

### 2.2 MVVM アーキテクチャ設計
```csharp
// サービス間の依存関係とデータフロー
public interface IDatabaseService
{
    Task<VideoFile?> GetVideoFileAsync(string id);
    Task<List<VideoFile>> SearchVideoFilesAsync(SearchFilter filter);
    Task SaveVideoFileAsync(VideoFile videoFile);
    Task<bool> DeleteVideoFileAsync(string id);
}

public interface IVideoScanService
{
    Task ScanDirectoriesAsync(List<string> directories, 
        IProgress<ScanProgress>? progress = null, 
        CancellationToken cancellationToken = default);
}

public interface IThumbnailService
{
    Task<string?> GenerateThumbnailAsync(string videoPath, 
        CancellationToken cancellationToken = default);
}

public interface IConfigurationService
{
    Task<AppSettings> LoadSettingsAsync();
    Task SaveSettingsAsync(AppSettings settings);
}

// MVVM データバインディング
public class MainViewModel : ObservableObject
{
    // ビューとの双方向データバインディング
    [ObservableProperty] private ObservableCollection<VideoFile> videoFiles;
    [ObservableProperty] private string searchQuery;
    [ObservableProperty] private bool isScanning;
    
    // コマンドバインディング
    [RelayCommand] private async Task ScanVideosAsync();
    [RelayCommand] private async Task SearchVideosAsync();
    [RelayCommand] private async Task PlayVideoAsync(VideoFile video);
}
```

## 3. データ設計

### 3.1 LiteDB スキーマ設計
```csharp
// LiteDB コレクション: VideoFiles
public class VideoFile
{
    [BsonId] public string Id { get; set; }           // 主キー
    public string FilePath { get; set; }              // ファイルパス (一意制約)
    public string FileName { get; set; }              // ファイル名
    public long FileSize { get; set; }                // ファイルサイズ (bytes)
    public double Duration { get; set; }              // 再生時間 (seconds)
    public int Width { get; set; }                    // 解像度 (幅)
    public int Height { get; set; }                   // 解像度 (高さ)
    public string? ThumbnailPath { get; set; }        // サムネイルパス
    public DateTime CreatedAt { get; set; }           // 作成日時
    public DateTime ModifiedAt { get; set; }          // 更新日時
    public DateTime ScanDate { get; set; }            // スキャン日時
    public bool IsDeleted { get; set; }               // 削除フラグ
}

// 複合インデックス設計 (パフォーマンス最適化)
videoFiles.EnsureIndex("FilePath", true);                    // 一意インデックス
videoFiles.EnsureIndex("FileName");                          // ファイル名検索
videoFiles.EnsureIndex("IsDeleted_ScanDate", 
    x => new { x.IsDeleted, x.ScanDate });                   // 複合インデックス
videoFiles.EnsureIndex("FileSize");                          // ファイルサイズ検索
videoFiles.EnsureIndex("Duration");                          // 再生時間検索

// アプリケーション設定 (JSON ファイル)
public class AppSettings
{
    public List<string> ScanDirectories { get; set; } = new();
    public int ThumbnailSize { get; set; } = 320;
    public string FFmpegPath { get; set; } = string.Empty;
    public string Theme { get; set; } = "Light";
    public string DefaultPlayer { get; set; } = string.Empty;
    public List<VideoFormat> SupportedFormats { get; set; } = new();
}
```

### 3.2 データモデル定義
```csharp
// 検索フィルタークラス
public class SearchFilter
{
    public string? Query { get; set; }                    // 検索クエリ
    public List<string>? Directories { get; set; }       // 対象ディレクトリ
    public List<VideoFormat>? Formats { get; set; }      // 対象形式
    public long? MinSize { get; set; }                    // 最小ファイルサイズ (bytes)
    public long? MaxSize { get; set; }                    // 最大ファイルサイズ (bytes)  
    public double? MinDuration { get; set; }              // 最小再生時間 (seconds)
    public double? MaxDuration { get; set; }              // 最大再生時間 (seconds)
}

// 動画形式列挙型
public enum VideoFormat
{
    Mp4,
    Avi, 
    Mkv,
    Ts
}

// スキャン進行状況
public class ScanProgress
{
    public int TotalFiles { get; set; }                   // 総ファイル数
    public int ProcessedFiles { get; set; }               // 処理済みファイル数
    public string CurrentFile { get; set; } = string.Empty; // 現在処理中のファイル
    public double ProgressPercentage => TotalFiles > 0 ? 
        (double)ProcessedFiles / TotalFiles * 100 : 0;    // 進行率
}

// UI用ビューモデルベース
public abstract class BaseViewModel : ObservableObject, INotifyPropertyChanged
{
    protected void OnPropertyChanged([CallerMemberName] string? propertyName = null)
    {
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }
    
    public event PropertyChangedEventHandler? PropertyChanged;
}
```

## 4. UI設計

### 4.1 画面構成
```
┌─────────────────────────────────────────┐
│ MenuBar                                 │
├─────────────────────────────────────────┤
│ SearchBar & Filters                     │
├─────────────────────────────────────────┤
│                                         │
│            Video Grid                   │
│  ┌───────┐ ┌───────┐ ┌───────┐         │
│  │Thumb  │ │Thumb  │ │Thumb  │         │
│  │Title  │ │Title  │ │Title  │  ...    │
│  │Meta   │ │Meta   │ │Meta   │         │
│  └───────┘ └───────┘ └───────┘         │
│                                         │
├─────────────────────────────────────────┤
│ StatusBar (件数表示等)                   │
└─────────────────────────────────────────┘
```

### 4.2 主要UI コンポーネント
```xml
<!-- メインウィンドウレイアウト (MainWindow.xaml) -->
<Grid>
  <Grid.RowDefinitions>
    <RowDefinition Height="Auto"/>    <!-- 検索バー -->
    <RowDefinition Height="*"/>       <!-- 動画グリッド -->
    <RowDefinition Height="Auto"/>    <!-- ステータスバー -->
  </Grid.RowDefinitions>
  
  <!-- 検索・フィルターエリア -->
  <StackPanel Grid.Row="0" Style="{StaticResource SearchPanelStyle}">
    <TextBox Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
             Style="{StaticResource SearchTextBoxStyle}"/>
    <Button Content="スキャン" Command="{Binding ScanCommand}"/>
    <Button Content="設定" Command="{Binding OpenSettingsCommand}"/>
  </StackPanel>
  
  <!-- 動画グリッド表示 -->
  <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
    <ItemsControl ItemsSource="{Binding FilteredVideoFiles}">
      <ItemsControl.ItemsPanel>
        <ItemsPanelTemplate>
          <WrapPanel Orientation="Horizontal"/>
        </ItemsPanelTemplate>
      </ItemsControl.ItemsPanel>
      
      <!-- 動画カードテンプレート -->
      <ItemsControl.ItemTemplate>
        <DataTemplate>
          <Border Style="{StaticResource VideoCardStyle}"
                  Width="{Binding DataContext.ThumbnailSize, 
                          RelativeSource={RelativeSource AncestorType=Window},
                          Converter={StaticResource ThumbnailSizeToWidthConverter}}">
            <Grid>
              <!-- サムネイル画像 -->
              <Image Source="{Binding ThumbnailPath}"
                     Height="{Binding DataContext.ThumbnailSize, 
                             RelativeSource={RelativeSource AncestorType=Window},
                             Converter={StaticResource ThumbnailSizeToHeightConverter}}"/>
              
              <!-- 動画情報（タグ形式表示） -->
              <WrapPanel Orientation="Horizontal">
                <TextBlock Text="{Binding FileName}"/>
                <Border Style="{StaticResource InfoTagStyle}">
                  <TextBlock Text="{Binding FileSize, Converter={StaticResource FileSizeConverter}}"/>
                </Border>
                <Border Style="{StaticResource InfoTagStyle}">
                  <TextBlock Text="{Binding Duration, Converter={StaticResource DurationConverter}}"/>
                </Border>
                <Border Style="{StaticResource InfoTagStyle}">
                  <TextBlock Text="{Binding Width}x{Binding Height}"/>
                </Border>
              </WrapPanel>
              
              <!-- アクションボタン -->
              <StackPanel Orientation="Horizontal">
                <Button Content="再生" Command="{Binding PlayVideoCommand}" 
                        CommandParameter="{Binding}"/>
                <Button Content="削除" Command="{Binding DeleteVideoCommand}" 
                        CommandParameter="{Binding}"/>
              </StackPanel>
            </Grid>
          </Border>
        </DataTemplate>
      </ItemsControl.ItemTemplate>
    </ItemsControl>
  </ScrollViewer>
</Grid>
```

## 5. 処理フロー設計

### 5.1 WPF アプリケーション起動フロー
```
1. App.xaml.cs Application_Startup イベント発火
2. DI コンテナー初期化 (Microsoft.Extensions.DependencyInjection)
3. サービス登録 (DatabaseService, VideoScanService, etc.)
4. LiteDB データベース初期化・インデックス作成
5. 設定ファイル読み込み (config/appsettings.json)
6. MainWindow 表示・ViewModel データバインディング
7. 前回スキャンデータの読み込み・UI 更新
8. FFmpeg パス検証・サムネイル生成準備
9. 初期表示完了・ユーザー操作待機
```

### 5.2 ファイルスキャンフロー (並列処理最適化)
```
1. ユーザーがスキャンボタンクリック
2. ScanCommand 実行・重複起動防止チェック
3. 設定から対象ディレクトリ取得
4. Directory.EnumerateFiles による再帰的ファイル探索
5. 拡張子による動画ファイル判定 (.mp4, .avi, .mkv, .ts)
6. 並列処理による高速化:
   - FFMpegCore でメタデータ抽出 (解像度、再生時間)
   - サムネイル生成 (中間フレーム、PNG形式)
   - LiteDB への保存処理
7. IProgress<ScanProgress> による進行状況更新
8. UI スレッドでの ObservableCollection 更新
9. スキャン完了・結果表示
```

### 5.3 高速検索・フィルタリングフロー (インデックス最適化)
```
1. ユーザーが検索ボックスに入力 (UpdateSourceTrigger=PropertyChanged)
2. SearchFilter オブジェクト構築 (Query, MinSize, MaxSize, etc.)
3. DatabaseService.SearchVideoFilesAsync 実行
4. 複合インデックス利用による高速クエリ:
   - IsDeleted=false でフィルタリング
   - FileName.Contains() による部分一致検索
   - FileSize, Duration による範囲検索
5. LiteDB から結果取得 (数ミリ秒)
6. ObservableCollection<VideoFile> 更新
7. WPF データバインディングによる UI 自動更新
8. 検索結果件数表示・レスポンシブレイアウト調整
```

## 6. エラーハンドリング設計

### 6.1 エラー分類
- **システムエラー**: ファイルアクセス権限、メモリ不足等
- **データエラー**: データベース破損、ファイル破損等
- **ユーザーエラー**: 無効な入力、存在しないパス等

### 6.2 エラー処理方針・実装
- **包括的ログ出力**: Serilog によるファイル名・行番号付きログ
- **ユーザーフレンドリーメッセージ**: MessageBox.Show でわかりやすい日本語表示
- **グレースフル degradation**: 致命的エラー以外はアプリケーション継続
- **自動復旧機能**: データベースロック解決・FFmpeg パス自動検出
- **UI スレッド保護**: Dispatcher.Invoke による適切なスレッド処理
- **リソース管理**: using ステートメントによる確実なリソース解放

## 7. パフォーマンス設計

### 7.1 パフォーマンス最適化実装
- **WPF 仮想化**: ItemsControl による大量データ表示の最適化
- **並列処理**: Task.Run でサムネイル生成・スキャン処理の並列実行
- **LiteDB インデックス**: 複合インデックスによる数ミリ秒検索実現
- **サムネイルキャッシュ**: PNG ファイルキャッシュ・重複生成防止
- **レスポンシブレイアウト**: カスタムコンバーターによる動的サイジング (100-600px)
- **メモリ効率化**: WeakReference・適切な Dispose パターン

### 7.2 メモリ管理・実測値
- **サムネイル画像**: PNG 形式、1件あたり約50KB、ファイルキャッシュ利用
- **メモリ使用量**: 最大512MB (動画1000件表示時)
- **データベースサイズ**: 動画1000件で約10MB (LiteDB圧縮)
- **実行ファイルサイズ**: 164MB (全依存関係内包、単一exe)
- **スキャン速度**: 約1000ファイル/分 (SSD環境)
- **検索速度**: インデックス使用により数ミリ秒で結果表示

## 8. セキュリティ設計

### 8.1 ファイルアクセス制御
- 読み取り専用でのファイルアクセス
- システムファイルへのアクセス制限
- パス正規化による不正アクセス防止

### 8.2 データ保護
- SQLインジェクション対策
- ファイルパスサニタイゼーション
- 設定ファイルの暗号化