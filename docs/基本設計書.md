# MovieMonitor 基本設計書

## 1. システム概要

### 1.1 システム構成
```
┌─────────────────────┐
│   Electron Main     │  ← メインプロセス
│   - ウィンドウ管理  │
│   - ファイル操作    │
│   - データベース    │
└─────────────────────┘
           │
           │ IPC通信
           │
┌─────────────────────┐
│  Electron Renderer  │  ← レンダラープロセス
│   - React UI        │
│   - ユーザー操作    │
│   - 画面表示        │
└─────────────────────┘
```

### 1.2 技術スタック
- **アプリケーションフレームワーク**: Electron
- **フロントエンド**: React + TypeScript
- **データベース**: SQLite (better-sqlite3)
- **動画処理**: FFmpeg.js
- **UI Components**: 自作コンポーネント
- **状態管理**: React Context + useReducer
- **ビルドツール**: Webpack

## 2. アーキテクチャ設計

### 2.1 ディレクトリ構造
```
MovieMonitor/
├── src/
│   ├── main/                    # メインプロセス
│   │   ├── main.ts             # アプリケーション起動
│   │   ├── window.ts           # ウィンドウ管理
│   │   ├── database/
│   │   │   ├── database.ts     # SQLite接続・操作
│   │   │   └── models.ts       # データモデル定義
│   │   ├── scanner/
│   │   │   ├── file-scanner.ts # ファイルスキャナー
│   │   │   └── metadata-extractor.ts # メタデータ抽出
│   │   ├── thumbnail/
│   │   │   └── thumbnail-generator.ts # サムネイル生成
│   │   └── ipc/
│   │       └── ipc-handlers.ts # IPC通信ハンドラー
│   ├── renderer/               # レンダラープロセス
│   │   ├── components/
│   │   │   ├── common/         # 共通コンポーネント
│   │   │   ├── search/         # 検索関連
│   │   │   ├── video-list/     # 動画一覧
│   │   │   └── layout/         # レイアウト
│   │   ├── hooks/              # カスタムフック
│   │   ├── context/            # React Context
│   │   ├── utils/              # ユーティリティ
│   │   ├── types/              # 型定義
│   │   └── App.tsx             # メインApp
│   └── shared/                 # 共通
│       ├── types/              # 共有型定義
│       └── constants/          # 定数定義
├── assets/                     # 静的ファイル
├── docs/                       # ドキュメント
├── webpack.*.js               # Webpack設定
└── package.json
```

### 2.2 プロセス間通信設計
```typescript
// IPC通信チャンネル定義
interface IPCChannels {
  // ファイルスキャン
  'scan-videos': {
    request: { directories?: string[] };
    response: VideoFile[];
  };
  
  // 検索
  'search-videos': {
    request: SearchFilter;
    response: VideoFile[];
  };
  
  // サムネイル生成
  'generate-thumbnail': {
    request: { filePath: string };
    response: string; // thumbnail path
  };
  
  // ファイル操作
  'open-video': {
    request: { filePath: string };
    response: boolean;
  };
  
  'move-video': {
    request: { from: string; to: string };
    response: boolean;
  };
  
  'delete-video': {
    request: { filePath: string };
    response: boolean;
  };
}
```

## 3. データ設計

### 3.1 データベーススキーマ
```sql
-- 動画ファイル情報テーブル
CREATE TABLE video_files (
  id TEXT PRIMARY KEY,
  file_path TEXT UNIQUE NOT NULL,
  file_name TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  duration REAL NOT NULL,
  width INTEGER NOT NULL,
  height INTEGER NOT NULL,
  thumbnail_path TEXT,
  created_at DATETIME NOT NULL,
  modified_at DATETIME NOT NULL,
  scan_date DATETIME NOT NULL,
  is_deleted BOOLEAN DEFAULT FALSE
);

-- インデックス
CREATE INDEX idx_file_name ON video_files(file_name);
CREATE INDEX idx_file_size ON video_files(file_size);
CREATE INDEX idx_duration ON video_files(duration);
CREATE INDEX idx_scan_date ON video_files(scan_date);

-- 設定テーブル
CREATE TABLE app_settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
);
```

### 3.2 データモデル
```typescript
// 動画ファイル情報
interface VideoFile {
  id: string;
  filePath: string;
  fileName: string;
  fileSize: number;        // bytes
  duration: number;        // seconds
  width: number;
  height: number;
  thumbnailPath?: string;
  createdAt: Date;
  modifiedAt: Date;
  scanDate: Date;
}

// 検索フィルター
interface SearchFilter {
  query?: string;
  directories?: string[];
  formats?: VideoFormat[];
  minSize?: number;        // bytes
  maxSize?: number;        // bytes
  minDuration?: number;    // seconds
  maxDuration?: number;    // seconds
}

// 動画形式
type VideoFormat = 'mp4' | 'avi' | 'mkv' | 'ts';

// アプリ設定
interface AppSettings {
  scanDirectories: string[];
  thumbnailSize: number;
  defaultPlayer?: string;
  theme: 'light' | 'dark';
}
```

## 4. UI設計

### 4.1 画面構成
```
┌─────────────────────────────────────────┐
│ MenuBar                                 │
├─────────────────────────────────────────┤
│ SearchBar & Filters                     │
├─────────────────────────────────────────┤
│                                         │
│            Video Grid                   │
│  ┌───────┐ ┌───────┐ ┌───────┐         │
│  │Thumb  │ │Thumb  │ │Thumb  │         │
│  │Title  │ │Title  │ │Title  │  ...    │
│  │Meta   │ │Meta   │ │Meta   │         │
│  └───────┘ └───────┘ └───────┘         │
│                                         │
├─────────────────────────────────────────┤
│ StatusBar (件数表示等)                   │
└─────────────────────────────────────────┘
```

### 4.2 主要コンポーネント
```typescript
// メインレイアウト
const App: React.FC = () => {
  return (
    <div className="app">
      <Header />
      <SearchSection />
      <VideoGrid />
      <StatusBar />
    </div>
  );
};

// 検索セクション
const SearchSection: React.FC = () => {
  return (
    <div className="search-section">
      <SearchInput />
      <FilterPanel />
    </div>
  );
};

// 動画グリッド
const VideoGrid: React.FC = () => {
  return (
    <div className="video-grid">
      {videos.map(video => 
        <VideoCard key={video.id} video={video} />
      )}
    </div>
  );
};

// 動画カード
const VideoCard: React.FC<{video: VideoFile}> = ({video}) => {
  return (
    <div className="video-card">
      <img src={video.thumbnailPath} />
      <h3>{video.fileName}</h3>
      <div className="metadata">
        <span>{formatSize(video.fileSize)}</span>
        <span>{formatDuration(video.duration)}</span>
        <span>{video.width}x{video.height}</span>
      </div>
      <ActionButtons video={video} />
    </div>
  );
};
```

## 5. 処理フロー設計

### 5.1 アプリケーション起動フロー
```
1. メインプロセス起動
2. SQLiteデータベース初期化
3. レンダラープロセス起動
4. UI表示
5. 前回スキャンデータの読み込み
6. 初期表示完了
```

### 5.2 ファイルスキャンフロー
```
1. ユーザーがスキャン開始
2. 対象ディレクトリの取得
3. 再帰的ファイル探索
4. 動画ファイル判定
5. メタデータ抽出
6. サムネイル生成
7. データベース保存
8. UI更新
```

### 5.3 検索・フィルタリングフロー
```
1. ユーザーが検索条件入力
2. SQLクエリ構築
3. データベース検索実行
4. 結果の取得
5. UI更新（グリッド表示）
```

## 6. エラーハンドリング設計

### 6.1 エラー分類
- **システムエラー**: ファイルアクセス権限、メモリ不足等
- **データエラー**: データベース破損、ファイル破損等
- **ユーザーエラー**: 無効な入力、存在しないパス等

### 6.2 エラー処理方針
- すべてのエラーはログ出力
- ユーザーには分かりやすいメッセージ表示
- 致命的エラー以外はアプリケーション継続
- 自動復旧機能の実装

## 7. パフォーマンス設計

### 7.1 最適化方針
- **UI仮想化**: 大量データ表示の最適化
- **並列処理**: サムネイル生成の並列実行
- **キャッシュ機能**: サムネイル・メタデータのキャッシュ
- **インデックス活用**: データベース検索の高速化

### 7.2 メモリ管理
- サムネイル画像のメモリ管理
- 不要データの定期的な開放
- ガベージコレクションの最適化

## 8. セキュリティ設計

### 8.1 ファイルアクセス制御
- 読み取り専用でのファイルアクセス
- システムファイルへのアクセス制限
- パス正規化による不正アクセス防止

### 8.2 データ保護
- SQLインジェクション対策
- ファイルパスサニタイゼーション
- 設定ファイルの暗号化