# MovieMonitor データ仕様書

## 1. データベース仕様

### 1.1 データベース概要
- **データベースエンジン**: SQLite 3.x
- **ファイル名**: moviemonitor.db
- **保存場所**: アプリケーションユーザーデータディレクトリ
- **文字エンコーディング**: UTF-8
- **ジャーナルモード**: WAL（Write-Ahead Logging）
- **外部キー制約**: 有効

### 1.2 テーブル仕様

#### 1.2.1 video_files テーブル
**概要**: 動画ファイルの基本情報を格納するメインテーブル

```sql
CREATE TABLE video_files (
    id TEXT PRIMARY KEY,                    -- ファイル識別子（UUID v4）
    file_path TEXT UNIQUE NOT NULL,         -- ファイル絶対パス
    file_name TEXT NOT NULL,                -- ファイル名
    file_size INTEGER NOT NULL,             -- ファイルサイズ（バイト）
    duration REAL NOT NULL,                 -- 再生時間（秒）
    width INTEGER NOT NULL,                 -- 動画幅（ピクセル）
    height INTEGER NOT NULL,                -- 動画高さ（ピクセル）
    thumbnail_path TEXT,                    -- サムネイルパス
    created_at DATETIME NOT NULL,           -- ファイル作成日時
    modified_at DATETIME NOT NULL,          -- ファイル更新日時
    scan_date DATETIME NOT NULL,            -- スキャン実行日時
    is_deleted BOOLEAN DEFAULT FALSE        -- 論理削除フラグ
);
```

**制約条件**:
```sql
-- チェック制約
ALTER TABLE video_files ADD CONSTRAINT chk_file_size_positive 
    CHECK (file_size > 0);
    
ALTER TABLE video_files ADD CONSTRAINT chk_duration_non_negative 
    CHECK (duration >= 0);
    
ALTER TABLE video_files ADD CONSTRAINT chk_resolution_positive 
    CHECK (width > 0 AND height > 0);
    
ALTER TABLE video_files ADD CONSTRAINT chk_file_path_not_empty 
    CHECK (length(trim(file_path)) > 0);
```

**インデックス**:
```sql
-- 検索性能向上のためのインデックス
CREATE INDEX idx_video_files_file_name ON video_files(file_name);
CREATE INDEX idx_video_files_file_size ON video_files(file_size);
CREATE INDEX idx_video_files_duration ON video_files(duration);
CREATE INDEX idx_video_files_scan_date ON video_files(scan_date DESC);
CREATE INDEX idx_video_files_resolution ON video_files(width, height);
CREATE INDEX idx_video_files_is_deleted ON video_files(is_deleted);

-- 複合インデックス
CREATE INDEX idx_video_files_search ON video_files(is_deleted, scan_date DESC);
```

**データ例**:
```sql
INSERT INTO video_files VALUES (
    '550e8400-e29b-41d4-a716-446655440000',
    'C:\Users\username\Videos\sample_video.mp4',
    'sample_video.mp4',
    104857600,                              -- 100MB
    3600.5,                                 -- 1時間0.5秒
    1920,
    1080,
    'C:\Users\username\AppData\Local\MovieMonitor\thumbnails\550e8400.jpg',
    '2024-01-15T10:30:00.000Z',
    '2024-01-15T10:30:00.000Z',
    '2024-01-20T15:45:30.000Z',
    FALSE
);
```

#### 1.2.2 app_settings テーブル
**概要**: アプリケーション設定を格納

```sql
CREATE TABLE app_settings (
    key TEXT PRIMARY KEY,                   -- 設定キー
    value TEXT NOT NULL,                    -- 設定値（JSON文字列可）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**設定項目一覧**:
| キー | データ型 | デフォルト値 | 説明 |
|-----|---------|------------|------|
| scan_directories | JSON Array | [] | スキャン対象ディレクトリ一覧 |
| thumbnail_size | Number | 320 | サムネイルサイズ（ピクセル）|
| theme | String | "light" | UIテーマ（light/dark）|
| last_scan_date | ISO String | null | 最後のスキャン実行日時 |
| default_player | String | null | デフォルト動画プレーヤーパス |
| supported_formats | JSON Array | ["mp4","avi","mkv","ts"] | 対応動画形式 |
| auto_scan | Boolean | false | 自動スキャン有効/無効 |

**データ例**:
```sql
INSERT INTO app_settings VALUES
('scan_directories', '["C:\\Users\\username\\Videos", "D:\\Movies"]', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
('thumbnail_size', '320', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
('theme', 'light', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
('supported_formats', '["mp4", "avi", "mkv", "ts"]', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);
```

#### 1.2.3 scan_history テーブル（将来拡張用）
**概要**: スキャン実行履歴の記録

```sql
CREATE TABLE scan_history (
    id TEXT PRIMARY KEY,                    -- スキャン履歴ID（UUID）
    directory_path TEXT NOT NULL,           -- スキャン対象ディレクトリ
    scan_start_time DATETIME NOT NULL,      -- スキャン開始時刻
    scan_end_time DATETIME,                 -- スキャン終了時刻
    files_found INTEGER NOT NULL DEFAULT 0,    -- 発見ファイル数
    files_processed INTEGER NOT NULL DEFAULT 0, -- 処理済ファイル数
    files_failed INTEGER NOT NULL DEFAULT 0,    -- 処理失敗ファイル数
    status TEXT NOT NULL DEFAULT 'running',     -- スキャン状態
    error_message TEXT,                     -- エラーメッセージ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**ステータス値**:
- `running`: 実行中
- `completed`: 完了
- `error`: エラー終了
- `cancelled`: キャンセル

## 2. ファイル仕様

### 2.1 サムネイル画像仕様

**保存場所**: `{ユーザーデータディレクトリ}/thumbnails/`

**ファイル形式**:
- **形式**: JPEG
- **サイズ**: 320x240ピクセル（デフォルト）
- **品質**: 85%
- **ファイル名**: `{MD5ハッシュ}.jpg`

**ファイル名生成ロジック**:
```typescript
function generateThumbnailFileName(filePath: string): string {
    const hash = crypto.createHash('md5')
        .update(filePath, 'utf8')
        .digest('hex');
    return `${hash}.jpg`;
}
```

**サムネイル生成仕様**:
- **抽出位置**: 動画の50%再生位置
- **コマンド例**: `ffmpeg -i input.mp4 -ss 50% -vframes 1 -q:v 2 -s 320x240 output.jpg`
- **エラー時**: デフォルト画像（no-thumbnail.jpg）を使用

### 2.2 ログファイル仕様

**保存場所**: `{ユーザーデータディレクトリ}/logs/`

**ログレベル**:
- `ERROR`: エラー情報
- `WARN`: 警告情報  
- **INFO**: 一般情報
- `DEBUG`: デバッグ情報

**ログローテーション**:
- **最大ファイルサイズ**: 10MB
- **保持ファイル数**: 5個
- **ファイル名パターン**: `app-YYYY-MM-DD.log`

## 3. API仕様（IPC通信）

### 3.1 リクエスト/レスポンス形式

#### 3.1.1 動画スキャン
```typescript
// リクエスト
interface ScanVideosRequest {
    directories?: string[];  // 未指定時は全ドライブスキャン
}

// レスポンス  
interface ScanVideosResponse {
    success: boolean;
    data?: VideoFile[];
    error?: {
        code: string;
        message: string;
    };
}
```

#### 3.1.2 動画検索
```typescript
// リクエスト
interface SearchVideosRequest {
    query?: string;          // ファイル名検索
    directories?: string[];  // 対象ディレクトリ
    formats?: VideoFormat[]; // ファイル形式
    minSize?: number;        // 最小ファイルサイズ（バイト）
    maxSize?: number;        // 最大ファイルサイズ（バイト）
    minDuration?: number;    // 最小再生時間（秒）
    maxDuration?: number;    // 最大再生時間（秒）
    limit?: number;          // 取得件数制限
    offset?: number;         // 取得開始位置
}

// レスポンス
interface SearchVideosResponse {
    success: boolean;
    data?: {
        videos: VideoFile[];
        total: number;       // 総件数
        hasMore: boolean;    // さらに結果があるか
    };
    error?: {
        code: string;
        message: string;
    };
}
```

#### 3.1.3 ファイル操作
```typescript
// 動画再生
interface OpenVideoRequest {
    filePath: string;
}

interface OpenVideoResponse {
    success: boolean;
    error?: {
        code: string;
        message: string;
    };
}

// ファイル移動
interface MoveVideoRequest {
    from: string;    // 移動元パス
    to: string;      // 移動先パス
}

interface MoveVideoResponse {
    success: boolean;
    newPath?: string;  // 実際の移動先パス
    error?: {
        code: string;
        message: string;
    };
}

// ファイル削除
interface DeleteVideoRequest {
    filePath: string;
    permanent?: boolean;  // 完全削除フラグ（デフォルト: false）
}

interface DeleteVideoResponse {
    success: boolean;
    error?: {
        code: string;
        message: string;
    };
}
```

### 3.2 エラーコード仕様

| コード | 説明 | 対応方法 |
|--------|------|----------|
| FILE_NOT_FOUND | ファイルが見つからない | ファイル存在確認 |
| ACCESS_DENIED | アクセス権限がない | 管理者権限で実行 |
| DISK_FULL | ディスク容量不足 | 空き容量確保 |
| INVALID_FORMAT | 非対応ファイル形式 | 対応形式確認 |
| DATABASE_ERROR | データベースエラー | DB修復・再作成 |
| METADATA_ERROR | メタデータ取得エラー | FFmpeg確認 |
| THUMBNAIL_ERROR | サムネイル生成エラー | FFmpeg確認 |

## 4. データ変換仕様

### 4.1 ファイルサイズ表示

```typescript
function formatFileSize(bytes: number): string {
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = bytes;
    let unitIndex = 0;
    
    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }
    
    return `${size.toFixed(unitIndex === 0 ? 0 : 1)} ${units[unitIndex]}`;
}
```

### 4.2 再生時間表示

```typescript  
function formatDuration(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
}
```

### 4.3 解像度分類

```typescript
function getResolutionCategory(width: number, height: number): string {
    if (width >= 3840 && height >= 2160) return '4K';
    if (width >= 2560 && height >= 1440) return '2K';
    if (width >= 1920 && height >= 1080) return 'Full HD';
    if (width >= 1280 && height >= 720) return 'HD';
    if (width >= 854 && height >= 480) return 'SD';
    return 'Low';
}
```

## 5. バックアップ・復元仕様

### 5.1 データバックアップ

**バックアップ対象**:
- データベースファイル（moviemonitor.db）
- 設定ファイル
- サムネイル画像（オプション）

**バックアップ形式**:
```json
{
    "version": "1.0",
    "createdAt": "2024-01-20T15:30:00Z",
    "database": {
        "filename": "moviemonitor.db",
        "size": 1048576,
        "checksum": "a1b2c3d4e5f6..."
    },
    "thumbnails": {
        "count": 150,
        "totalSize": 52428800
    }
}
```

### 5.2 データベース最適化

**実行タイミング**:
- アプリ起動時（週1回）
- 手動実行

**最適化処理**:
```sql
-- 削除済みレコードの物理削除
DELETE FROM video_files WHERE is_deleted = TRUE AND scan_date < datetime('now', '-30 days');

-- データベースの圧縮
VACUUM;

-- 統計情報の更新  
ANALYZE;

-- インデックスの再構築
REINDEX;
```

## 6. セキュリティ仕様

### 6.1 入力値検証

**ファイルパス検証**:
```typescript
function validateFilePath(path: string): boolean {
    // 不正文字チェック
    const invalidChars = /[<>"|?*\x00-\x1f]/;
    if (invalidChars.test(path)) return false;
    
    // パストラバーサル防止
    if (path.includes('..')) return false;
    
    // 絶対パスチェック（Windows）
    if (!/^[A-Z]:\\/.test(path)) return false;
    
    return true;
}
```

**SQLインジェクション対策**:
- Prepared Statementの使用
- 動的クエリの禁止
- パラメータバインディング

### 6.2 アクセス制御

**ファイルアクセス制限**:
- 読み取り専用でのファイルアクセス
- システムディレクトリへのアクセス禁止
- 実行可能ファイルの除外

**データベースアクセス**:
- ファイルレベルでの排他制御
- トランザクション制御
- デッドロック検出・回避

## 7. パフォーマンス仕様

### 7.1 処理時間目標

| 処理 | 目標時間 | 備考 |
|------|----------|------|
| アプリ起動 | 3秒以内 | 初回起動除く |
| 動画リスト表示 | 1秒以内 | 1000件まで |
| 検索実行 | 0.5秒以内 | インデックス使用 |
| サムネイル生成 | 5秒以内 | 1ファイル当たり |

### 7.2 メモリ使用量

**制限値**:
- **最大メモリ使用量**: 512MB
- **サムネイルキャッシュ**: 100MB
- **データベースキャッシュ**: 50MB

### 7.3 ディスク使用量

**見積もり**:
- データベース: 動画1000件で約10MB
- サムネイル: 1件あたり約50KB
- ログファイル: 最大50MB（ローテーション後）